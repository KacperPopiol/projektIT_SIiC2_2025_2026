import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import { groupsApi } from '../api/groupsApi'
import { useAuth } from '../hooks/useAuth'
import { generateGroupKey, exportGroupKey, cacheGroupKey, getCachedGroupKey } from '../utils/groupEncryption'
import { getPrivateKeyDHLocally, importPrivateKeyDH } from '../utils/encryption'
import { keysApi } from '../api/keysApi'

const GroupsPage = () => {
	const navigate = useNavigate()
	const { user } = useAuth()

	const [groups, setGroups] = useState([])
	const [selectedGroup, setSelectedGroup] = useState(null)
	const [groupMembers, setGroupMembers] = useState([])
	const [pendingRequests, setPendingRequests] = useState([])

	const [showCreateGroup, setShowCreateGroup] = useState(false)
	const [groupName, setGroupName] = useState('')

	const [showJoinGroup, setShowJoinGroup] = useState(false)
	const [inviteCode, setInviteCode] = useState('')

	const [generatedCode, setGeneratedCode] = useState('')
	const [showGeneratedCode, setShowGeneratedCode] = useState(false)
	const [editingGroupName, setEditingGroupName] = useState(false)
	const [newGroupName, setNewGroupName] = useState('')

	const [loading, setLoading] = useState(true)
	const [error, setError] = useState('')

	useEffect(() => {
		loadGroups()
	}, [])

	useEffect(() => {
		const interval = setInterval(() => {
			console.log('üîÑ Auto-refreshing groups...')
			loadGroups()
			if (selectedGroup) {
				loadGroupDetails(selectedGroup.group_id)
			}
		}, 3000) // 3 sekundy

		return () => clearInterval(interval)
	}, [selectedGroup])

	useEffect(() => {
		if (selectedGroup) {
			loadGroupDetails(selectedGroup.group_id)
		}
	}, [selectedGroup])

	const loadGroups = async () => {
		try {
			const response = await groupsApi.getMyGroups()
			setGroups(response.groups || [])
		} catch (err) {
			console.error('B≈ÇƒÖd ≈Çadowania grup:', err)
			setError('Nie uda≈Ço siƒô za≈Çadowaƒá grup')
		} finally {
			setLoading(false)
		}
	}

	const isGroupCreator = groupId => {
		const groupMember = groups.find(g => g.group_id === groupId)
		return groupMember?.role === 'creator'
	}

	const loadGroupDetails = async groupId => {
		try {
			// 1. Zawsze pobierz cz≈Çonk√≥w (ka≈ºdy cz≈Çonek ma dostƒôp)
			const membersRes = await groupsApi.getGroupMembers(groupId)
			setGroupMembers(membersRes.members || [])

			// 2. ‚úÖ NOWE: Automatycznie za≈Çaduj klucz grupowy (je≈õli istnieje)
			try {
				await loadGroupKeyIfNeeded(groupId)
			} catch (keyError) {
				console.warn('‚ö†Ô∏è Nie uda≈Ço siƒô za≈Çadowaƒá klucza grupowego:', keyError)
				// Nie blokuj ≈Çadowania szczeg√≥≈Ç√≥w grupy
			}

			// 3. Pobierz oczekujƒÖce pro≈õby TYLKO je≈õli jeste≈õ tw√≥rcƒÖ
			if (isGroupCreator(groupId)) {
				try {
					const pendingRes = await groupsApi.getPendingRequests(groupId)
					setPendingRequests(pendingRes.pendingRequests || [])
				} catch (err) {
					console.log('Nie mo≈ºna pobraƒá oczekujƒÖcych pr√≥≈õb (brak uprawnie≈Ñ)')
					setPendingRequests([])
				}
			} else {
				setPendingRequests([])
			}
		} catch (err) {
			console.error('B≈ÇƒÖd ≈Çadowania szczeg√≥≈Ç√≥w grupy:', err)
		}
	}

	/**
	 * Automatycznie inicjalizuje szyfrowanie dla nowo utworzonej grupy
	 */
	const initializeGroupEncryptionAuto = async groupId => {
		try {
			console.log('üîê Automatyczna inicjalizacja szyfrowania dla grupy:', groupId)

			// 1. Pobierz cz≈Çonk√≥w grupy (na razie tylko tw√≥rca)
			const membersResponse = await groupsApi.getGroupMembers(groupId)
			const members = membersResponse.members

			console.log(`üë• Znaleziono ${members.length} cz≈Çonk√≥w`)

			// 2. Wygeneruj klucz grupowy (AES-256)
			const groupKey = await generateGroupKey()
			const groupKeyJwk = await exportGroupKey(groupKey)

			console.log('üîë Klucz grupowy wygenerowany')

			// 3. Pobierz w≈Çasny klucz prywatny ECDH
			const myPrivateKeyJwk = getPrivateKeyDHLocally()
			if (!myPrivateKeyJwk) {
				throw new Error('Brak klucza prywatnego DH - zaloguj siƒô ponownie')
			}
			const myPrivateKey = await importPrivateKeyDH(myPrivateKeyJwk)

			// 4. Zaszyfruj klucz grupowy dla ka≈ºdego cz≈Çonka
			const encryptedKeys = []

			for (const member of members) {
				try {
					// Pobierz klucz publiczny cz≈Çonka
					const userKeyResponse = await keysApi.getPublicKeyDH(member.user_id)
					const userPublicKeyJwk = JSON.parse(userKeyResponse.publicKey)

					// Import klucza publicznego cz≈Çonka
					const userPublicKey = await crypto.subtle.importKey(
						'jwk',
						userPublicKeyJwk,
						{ name: 'ECDH', namedCurve: 'P-256' },
						false,
						[]
					)

					// Wylicz shared secret (ECDH)
					const sharedSecret = await crypto.subtle.deriveBits(
						{ name: 'ECDH', public: userPublicKey },
						myPrivateKey,
						256
					)

					// Derive AES key z shared secret
					const aesKey = await crypto.subtle.importKey('raw', sharedSecret, { name: 'AES-GCM' }, false, ['encrypt'])

					// Zaszyfruj klucz grupowy tym AES key
					const iv = crypto.getRandomValues(new Uint8Array(12))
					const encryptedGroupKey = await crypto.subtle.encrypt(
						{ name: 'AES-GCM', iv: iv },
						aesKey,
						new TextEncoder().encode(JSON.stringify(groupKeyJwk))
					)

					// Dodaj do listy
					encryptedKeys.push({
						userId: member.user_id,
						encryptedKey: JSON.stringify({
							ciphertext: btoa(String.fromCharCode(...new Uint8Array(encryptedGroupKey))),
							iv: btoa(String.fromCharCode(...iv)),
						}),
					})

					console.log(`‚úÖ Klucz zaszyfrowany dla ${member.user.username}`)
				} catch (memberError) {
					console.error(`‚ùå B≈ÇƒÖd szyfrowania dla cz≈Çonka ${member.user_id}:`, memberError)
				}
			}

			// 5. Wy≈õlij zaszyfrowane klucze do backendu
			await groupsApi.initializeGroupEncryption(groupId, encryptedKeys)

			// 6. Zapisz klucz grupowy lokalnie
			await cacheGroupKey(groupId, groupKey)

			console.log('‚úÖ Szyfrowanie grupowe zainicjalizowane automatycznie')
			return true
		} catch (error) {
			console.error('‚ùå B≈ÇƒÖd automatycznej inicjalizacji szyfrowania:', error)
			throw error
		}
	}

	const addGroupKeyForNewMember = async (groupId, memberId) => {
		try {
			console.log(`üîë Dodawanie klucza dla nowego cz≈Çonka ${memberId}`)

			// 1. Pobierz klucz grupowy z cache
			let groupKey = getCachedGroupKey(groupId)

			if (!groupKey) {
				console.warn('‚ö†Ô∏è Brak klucza grupowego w cache - pobieranie z serwera')
				groupKey = await loadGroupKeyIfNeeded(groupId)
			}

			// 2. Eksportuj klucz grupowy
			const groupKeyJwk = await exportGroupKey(groupKey)

			// 3. Pobierz klucz publiczny nowego cz≈Çonka
			const userKeyResponse = await keysApi.getPublicKeyDH(memberId)
			const userPublicKeyJwk = JSON.parse(userKeyResponse.publicKey)

			// 4. Pobierz w≈Çasny klucz prywatny
			const myPrivateKeyJwk = getPrivateKeyDHLocally()
			if (!myPrivateKeyJwk) {
				throw new Error('Brak klucza prywatnego DH')
			}
			const myPrivateKey = await importPrivateKeyDH(myPrivateKeyJwk)

			// 5. Import klucza publicznego cz≈Çonka
			const userPublicKey = await crypto.subtle.importKey(
				'jwk',
				userPublicKeyJwk,
				{ name: 'ECDH', namedCurve: 'P-256' },
				false,
				[]
			)

			// 6. Wylicz shared secret
			const sharedSecret = await crypto.subtle.deriveBits({ name: 'ECDH', public: userPublicKey }, myPrivateKey, 256)

			// 7. Derive AES key
			const aesKey = await crypto.subtle.importKey('raw', sharedSecret, { name: 'AES-GCM' }, false, ['encrypt'])

			// 8. Zaszyfruj klucz grupowy
			const iv = crypto.getRandomValues(new Uint8Array(12))
			const encryptedGroupKey = await crypto.subtle.encrypt(
				{ name: 'AES-GCM', iv: iv },
				aesKey,
				new TextEncoder().encode(JSON.stringify(groupKeyJwk))
			)

			const encryptedKeyData = JSON.stringify({
				ciphertext: btoa(String.fromCharCode(...new Uint8Array(encryptedGroupKey))),
				iv: btoa(String.fromCharCode(...iv)),
			})

			// 9. Wy≈õlij do backendu
			await groupsApi.addKeyForMember(groupId, memberId, encryptedKeyData)

			console.log(`‚úÖ Klucz dodany dla cz≈Çonka ${memberId}`)
			return true
		} catch (error) {
			console.error(`‚ùå B≈ÇƒÖd dodawania klucza dla cz≈Çonka ${memberId}:`, error)
			throw error
		}
	}

	const loadGroupKeyIfNeeded = async groupId => {
		try {
			console.log(`üîë Sprawdzanie klucza grupowego dla grupy ${groupId}`)

			// 1. Sprawd≈∫ cache lokalny
			let groupKey = await getCachedGroupKey(groupId)

			if (groupKey) {
				console.log(`‚úÖ Klucz grupowy za≈Çadowany z cache dla grupy ${groupId}`)
				return groupKey
			}

			console.log(`‚ö†Ô∏è Brak klucza w cache - pobieranie z serwera...`)

			// 2. Pobierz zaszyfrowany klucz z serwera
			try {
				const response = await keysApi.getGroupKey(groupId)

				if (!response.encryptedKey) {
					console.warn(`‚ö†Ô∏è Grupa ${groupId} nie ma skonfigurowanego szyfrowania`)
					return null
				}

				// 3. Parse zaszyfrowanych danych
				let encryptedKeyData
				if (typeof response.encryptedKey === 'string') {
					encryptedKeyData = JSON.parse(response.encryptedKey)
				} else {
					encryptedKeyData = response.encryptedKey
				}

				console.log(`üîê Zaszyfrowany klucz pobrany z serwera`)

				// 4. Pobierz klucz publiczny tw√≥rcy grupy
				const groupDetails = await groupsApi.getGroupDetails(groupId)

				if (!groupDetails.group?.creator?.public_key_dh) {
					throw new Error('Brak klucza publicznego tw√≥rcy grupy')
				}

				const creatorPublicKeyJwk = JSON.parse(groupDetails.group.creator.public_key_dh)
				console.log(`üë§ Klucz publiczny tw√≥rcy pobrany`)

				// 5. Pobierz w≈Çasny klucz prywatny
				const myPrivateKeyJwk = getPrivateKeyDHLocally()
				if (!myPrivateKeyJwk) {
					throw new Error('Brak klucza prywatnego DH')
				}
				const myPrivateKey = await importPrivateKeyDH(myPrivateKeyJwk)
				console.log(`üîë Klucz prywatny zaimportowany`)

				// 6. Import klucza publicznego tw√≥rcy
				const creatorPublicKey = await crypto.subtle.importKey(
					'jwk',
					creatorPublicKeyJwk,
					{ name: 'ECDH', namedCurve: 'P-256' },
					false,
					[]
				)

				// 7. Wylicz shared secret z tw√≥rcƒÖ grupy (ECDH)
				const sharedSecret = await crypto.subtle.deriveBits(
					{ name: 'ECDH', public: creatorPublicKey },
					myPrivateKey,
					256
				)
				console.log(`üîê Shared secret wyliczony`)

				// 8. Derive AES key z shared secret
				const aesKey = await crypto.subtle.importKey('raw', sharedSecret, { name: 'AES-GCM' }, false, ['decrypt'])

				// 9. Odszyfruj klucz grupowy
				const iv = Uint8Array.from(atob(encryptedKeyData.iv), c => c.charCodeAt(0))
				const ciphertext = Uint8Array.from(atob(encryptedKeyData.ciphertext), c => c.charCodeAt(0))

				const decryptedData = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, aesKey, ciphertext)

				// 10. Przekonwertuj odszyfrowane dane na string (to jest JWK)
				const decryptedString = new TextDecoder().decode(decryptedData)
				console.log(`üìù Odszyfrowano klucz grupowy`)

				// 11. Parse JSON do obiektu JWK
				const groupKeyJwk = JSON.parse(decryptedString)

				// 12. Importuj klucz AES z JWK
				const groupKeyObject = await crypto.subtle.importKey('jwk', groupKeyJwk, { name: 'AES-GCM' }, true, [
					'encrypt',
					'decrypt',
				])

				// 13. Zapisz w cache
				await cacheGroupKey(groupId, groupKeyObject)

				console.log(`‚úÖ Klucz grupowy odszyfrowany i zapisany dla grupy ${groupId}`)
				return groupKeyObject
			} catch (error) {
				if (error.response?.status === 404) {
					console.warn(`‚ö†Ô∏è Klucz grupowy nie istnieje dla grupy ${groupId}`)
					return null
				}
				throw error
			}
		} catch (error) {
			console.error(`‚ùå B≈ÇƒÖd ≈Çadowania klucza grupowego dla grupy ${groupId}:`, error)
			throw error
		}
	}

	const handleCreateGroup = async e => {
		e.preventDefault()
		try {
			setError('')

			console.log('üìù Tworzenie grupy:', groupName)

			// 1. Utw√≥rz grupƒô
			const response = await groupsApi.createGroup(groupName)
			const newGroupId = response.group.groupId

			console.log('‚úÖ Grupa utworzona:', newGroupId)

			setShowCreateGroup(false)
			setGroupName('')

			// 2. ‚úÖ Automatycznie zainicjalizuj szyfrowanie
			try {
				await initializeGroupEncryptionAuto(newGroupId)
				alert('‚úÖ Grupa utworzona i zabezpieczona end-to-end!')
			} catch (encryptError) {
				console.error('‚ö†Ô∏è B≈ÇƒÖd inicjalizacji szyfrowania:', encryptError)
				alert('‚ö†Ô∏è Grupa utworzona, ale nie uda≈Ço siƒô skonfigurowaƒá szyfrowania.\nMo≈ºesz to zrobiƒá p√≥≈∫niej rƒôcznie.')
			}

			// 3. Od≈õwie≈º listƒô grup
			await loadGroups()
		} catch (err) {
			setError(err.response?.data?.error || 'Nie uda≈Ço siƒô utworzyƒá grupy')
		}
	}

	const handleGenerateInvite = async groupId => {
		try {
			const response = await groupsApi.generateGroupInvite(groupId)
			setGeneratedCode(response.inviteCode)
			setShowGeneratedCode(true)

			setTimeout(() => {
				setShowGeneratedCode(false)
				setGeneratedCode('')
			}, 60000)
		} catch (err) {
			alert('B≈ÇƒÖd generowania kodu')
		}
	}

	const handleJoinGroup = async e => {
		e.preventDefault()
		try {
			setError('')
			await groupsApi.requestJoinGroup(inviteCode)
			setShowJoinGroup(false)
			setInviteCode('')
			alert('Pro≈õba o do≈ÇƒÖczenie wys≈Çana!')
			await loadGroups()
		} catch (err) {
			setError(err.response?.data?.error || 'Nie uda≈Ço siƒô do≈ÇƒÖczyƒá do grupy')
		}
	}

	const handleAcceptMember = async (groupId, memberId) => {
		try {
			setLoading(true)

			await groupsApi.acceptMember(groupId, memberId)

			try {
				await addGroupKeyForNewMember(groupId, memberId)
				alert('‚úÖ Cz≈Çonek zaakceptowany i otrzyma≈Ç klucz szyfrowania!')
			} catch (keyError) {
				console.error('‚ö†Ô∏è B≈ÇƒÖd dodawania klucza:', keyError)
				alert('‚ö†Ô∏è Cz≈Çonek zaakceptowany, ale nie uda≈Ço siƒô dodaƒá klucza szyfrowania')
			}

			await loadGroupDetails(groupId)
		} catch (error) {
			alert('B≈ÇƒÖd akceptacji: ' + (error.response?.data?.error || error.message))
		} finally {
			setLoading(false)
		}
	}

	const handleRejectMember = async (groupId, memberId) => {
		try {
			await groupsApi.rejectMember(groupId, memberId)
			alert('Pro≈õba odrzucona')
			await loadGroupDetails(groupId)
		} catch (err) {
			alert('B≈ÇƒÖd odrzucania pro≈õby')
		}
	}

	const handleRemoveMember = async (groupId, memberId) => {
		if (!confirm('Czy na pewno chcesz usunƒÖƒá tego cz≈Çonka?')) return

		try {
			await groupsApi.removeMember(groupId, memberId)
			alert('Cz≈Çonek usuniƒôty')
			loadGroupDetails(groupId)
		} catch (err) {
			alert('B≈ÇƒÖd usuwania cz≈Çonka')
		}
	}

	const handleLeaveGroup = async groupId => {
		if (!confirm('Czy na pewno chcesz opu≈õciƒá tƒô grupƒô?')) return

		try {
			await groupsApi.leaveGroup(groupId)
			alert('Opu≈õci≈Çe≈õ grupƒô')
			setSelectedGroup(null)
			loadGroups()
		} catch (err) {
			alert('B≈ÇƒÖd opuszczania grupy')
		}
	}

	const handleDeleteGroup = async groupId => {
		if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô grupƒô? Wszystkie wiadomo≈õci zostanƒÖ usuniƒôte!')) return

		try {
			await groupsApi.deleteGroup(groupId)
			alert('Grupa usuniƒôta')
			setSelectedGroup(null)
			loadGroups()
		} catch (err) {
			alert('B≈ÇƒÖd usuwania grupy')
		}
	}

	const handleUpdateGroupName = async (groupId, newName) => {
		if (!newName.trim()) {
			alert('Nazwa nie mo≈ºe byƒá pusta')
			return
		}

		try {
			await groupsApi.updateGroupName(groupId, newName)

			// Od≈õwie≈º dane
			await loadGroups()

			// Zaktualizuj wybranƒÖ grupƒô
			setSelectedGroup(prev => ({
				...prev,
				group_name: newName,
			}))

			alert('Nazwa grupy zaktualizowana!')
		} catch (err) {
			alert('B≈ÇƒÖd zmiany nazwy: ' + (err.response?.data?.error || err.message))
		}
	}

	if (loading) {
		return <div style={{ padding: '20px' }}>≈Åadowanie...</div>
	}

	return (
		<div style={{ display: 'flex', height: '100vh' }}>
			{/* Sidebar - Lista grup */}
			<div
				style={{
					width: '300px',
					borderRight: '1px solid #ddd',
					backgroundColor: '#f8f9fa',
					overflowY: 'auto',
					padding: '20px',
				}}>
				<button
					onClick={() => navigate('/chat')}
					style={{
						width: '100%',
						padding: '10px',
						backgroundColor: '#6c757d',
						color: 'white',
						border: 'none',
						borderRadius: '5px',
						cursor: 'pointer',
						marginBottom: '15px',
					}}>
					‚Üê Wr√≥ƒá do Czatu
				</button>

				<h2>üéØ Grupy</h2>
				<p style={{ fontSize: '12px', color: '#666', marginBottom: '20px' }}>{user?.username}</p>

				<button
					onClick={() => setShowCreateGroup(!showCreateGroup)}
					style={{
						width: '100%',
						padding: '12px',
						backgroundColor: '#28a745',
						color: 'white',
						border: 'none',
						borderRadius: '5px',
						cursor: 'pointer',
						marginBottom: '10px',
						fontWeight: 'bold',
					}}>
					‚ûï Utw√≥rz Grupƒô
				</button>

				<button
					onClick={() => setShowJoinGroup(!showJoinGroup)}
					style={{
						width: '100%',
						padding: '12px',
						backgroundColor: '#007bff',
						color: 'white',
						border: 'none',
						borderRadius: '5px',
						cursor: 'pointer',
						marginBottom: '20px',
						fontWeight: 'bold',
					}}>
					üîë Do≈ÇƒÖcz do Grupy
				</button>

				{/* Formularz tworzenia grupy */}
				{showCreateGroup && (
					<form onSubmit={handleCreateGroup} style={{ marginBottom: '20px' }}>
						<input
							type="text"
							value={groupName}
							onChange={e => setGroupName(e.target.value)}
							placeholder="Nazwa grupy"
							style={{
								width: '100%',
								padding: '10px',
								borderRadius: '5px',
								border: '1px solid #ddd',
								marginBottom: '10px',
							}}
							required
						/>
						<button
							type="submit"
							style={{
								width: '100%',
								padding: '10px',
								backgroundColor: '#28a745',
								color: 'white',
								border: 'none',
								borderRadius: '5px',
								cursor: 'pointer',
							}}>
							Utw√≥rz
						</button>
					</form>
				)}

				{/* Formularz do≈ÇƒÖczania do grupy */}
				{showJoinGroup && (
					<form onSubmit={handleJoinGroup} style={{ marginBottom: '20px' }}>
						<input
							type="text"
							value={inviteCode}
							onChange={e => setInviteCode(e.target.value.toUpperCase())}
							placeholder="Kod zaproszenia"
							maxLength={6}
							style={{
								width: '100%',
								padding: '10px',
								borderRadius: '5px',
								border: '1px solid #ddd',
								marginBottom: '10px',
								textAlign: 'center',
								fontFamily: 'monospace',
								letterSpacing: '3px',
							}}
							required
						/>
						<button
							type="submit"
							style={{
								width: '100%',
								padding: '10px',
								backgroundColor: '#007bff',
								color: 'white',
								border: 'none',
								borderRadius: '5px',
								cursor: 'pointer',
							}}>
							Do≈ÇƒÖcz
						</button>
					</form>
				)}

				{error && (
					<div
						style={{
							backgroundColor: '#f8d7da',
							color: '#721c24',
							padding: '10px',
							borderRadius: '5px',
							marginBottom: '15px',
							fontSize: '12px',
						}}>
						{error}
					</div>
				)}

				<h3 style={{ fontSize: '16px', marginBottom: '10px' }}>Twoje Grupy</h3>
				{groups.length === 0 ? (
					<p style={{ fontSize: '12px', color: '#999' }}>Brak grup</p>
				) : (
					groups.map(groupMember => {
						const group = groupMember.group
						return (
							<div
								key={group.group_id}
								onClick={() => setSelectedGroup(group)}
								style={{
									padding: '12px',
									backgroundColor: selectedGroup?.group_id === group.group_id ? '#007bff' : '#fff',
									color: selectedGroup?.group_id === group.group_id ? '#fff' : '#000',
									borderRadius: '5px',
									cursor: 'pointer',
									marginBottom: '8px',
									border: '1px solid #ddd',
								}}>
								<strong>{group.group_name}</strong>
								<div style={{ fontSize: '11px', opacity: 0.8, marginTop: '5px' }}>
									{groupMember.role === 'creator' ? 'üëë Tw√≥rca' : 'üë§ Cz≈Çonek'}
								</div>
							</div>
						)
					})
				)}
			</div>

			{/* Szczeg√≥≈Çy grupy */}
			<div style={{ flex: 1, padding: '20px', overflowY: 'auto' }}>
				{selectedGroup ? (
					<>
						{/* <h2>{selectedGroup.group_name}</h2> */}
						{editingGroupName ? (
							<div style={{ display: 'flex', gap: '10px', marginBottom: '20px' }}>
								<input
									type="text"
									value={newGroupName}
									onChange={e => setNewGroupName(e.target.value)}
									placeholder="Nowa nazwa grupy"
									style={{
										flex: 1,
										padding: '10px',
										borderRadius: '5px',
										border: '1px solid #ddd',
										fontSize: '16px',
									}}
									autoFocus
								/>
								<button
									onClick={async () => {
										if (newGroupName.trim()) {
											await handleUpdateGroupName(selectedGroup.group_id, newGroupName)
											setEditingGroupName(false)
											setNewGroupName('')
										}
									}}
									style={{
										padding: '10px 20px',
										backgroundColor: '#28a745',
										color: 'white',
										border: 'none',
										borderRadius: '5px',
										cursor: 'pointer',
									}}>
									‚úì Zapisz
								</button>
								<button
									onClick={() => {
										setEditingGroupName(false)
										setNewGroupName('')
									}}
									style={{
										padding: '10px 20px',
										backgroundColor: '#6c757d',
										color: 'white',
										border: 'none',
										borderRadius: '5px',
										cursor: 'pointer',
									}}>
									‚úï Anuluj
								</button>
							</div>
						) : (
							<div style={{ display: 'flex', alignItems: 'center', gap: '15px', marginBottom: '20px' }}>
								<h2 style={{ margin: 0 }}>{selectedGroup.group_name}</h2>
								{isGroupCreator(selectedGroup.group_id) && (
									<button
										onClick={() => {
											setNewGroupName(selectedGroup.group_name)
											setEditingGroupName(true)
										}}
										style={{
											padding: '6px 12px',
											backgroundColor: '#17a2b8',
											color: 'white',
											border: 'none',
											borderRadius: '5px',
											cursor: 'pointer',
											fontSize: '13px',
										}}>
										‚úèÔ∏è Zmie≈Ñ nazwƒô
									</button>
								)}
							</div>
						)}

						{/* Kod zaproszeniowy */}
						{showGeneratedCode && generatedCode && (
							<div
								style={{
									backgroundColor: '#d4edda',
									border: '2px solid #28a745',
									padding: '15px',
									borderRadius: '8px',
									marginBottom: '20px',
								}}>
								<h4>Kod Zaproszeniowy:</h4>
								<div
									style={{
										fontSize: '24px',
										fontWeight: 'bold',
										fontFamily: 'monospace',
										letterSpacing: '5px',
										margin: '10px 0',
									}}>
									{generatedCode}
								</div>
								<p style={{ fontSize: '12px' }}>Wa≈ºny przez 60 sekund!</p>
							</div>
						)}

						{/* Akcje tw√≥rcy */}
						{groups.find(g => g.group_id === selectedGroup.group_id)?.role === 'creator' && (
							<div style={{ display: 'flex', gap: '10px', marginBottom: '20px', flexWrap: 'wrap' }}>
								<button
									onClick={() => handleGenerateInvite(selectedGroup.group_id)}
									style={{
										padding: '10px 15px',
										backgroundColor: '#28a745',
										color: 'white',
										border: 'none',
										borderRadius: '5px',
										cursor: 'pointer',
									}}>
									üîë Generuj Kod
								</button>
								<button
									onClick={() => handleDeleteGroup(selectedGroup.group_id)}
									style={{
										padding: '10px 15px',
										backgroundColor: '#dc3545',
										color: 'white',
										border: 'none',
										borderRadius: '5px',
										cursor: 'pointer',
									}}>
									üóëÔ∏è Usu≈Ñ Grupƒô
								</button>
							</div>
						)}

						{/* Akcje cz≈Çonka */}
						{groups.find(g => g.group_id === selectedGroup.group_id)?.role === 'member' && (
							<button
								onClick={() => handleLeaveGroup(selectedGroup.group_id)}
								style={{
									padding: '10px 15px',
									backgroundColor: '#ffc107',
									color: '#000',
									border: 'none',
									borderRadius: '5px',
									cursor: 'pointer',
									marginBottom: '20px',
								}}>
								üö™ Opu≈õƒá Grupƒô
							</button>
						)}

						{/* OczekujƒÖce pro≈õby (tylko tw√≥rca) */}
						{pendingRequests.length > 0 &&
							groups.find(g => g.group_id === selectedGroup.group_id)?.role === 'creator' && (
								<div style={{ marginBottom: '30px' }}>
									<h3>üì© OczekujƒÖce Pro≈õby ({pendingRequests.length})</h3>
									{pendingRequests.map(request => (
										<div
											key={request.member_id}
											style={{
												backgroundColor: '#fff3cd',
												padding: '15px',
												borderRadius: '8px',
												marginTop: '10px',
												display: 'flex',
												justifyContent: 'space-between',
												alignItems: 'center',
											}}>
											<strong>{request.user?.username}</strong>
											<div style={{ display: 'flex', gap: '10px' }}>
												<button
													onClick={() => handleAcceptMember(selectedGroup.group_id, request.user_id)}
													style={{
														padding: '8px 15px',
														backgroundColor: '#28a745',
														color: 'white',
														border: 'none',
														borderRadius: '5px',
														cursor: 'pointer',
													}}>
													‚úÖ Akceptuj
												</button>
												<button
													onClick={() => handleRejectMember(selectedGroup.group_id, request.user_id)}
													style={{
														padding: '8px 15px',
														backgroundColor: '#dc3545',
														color: 'white',
														border: 'none',
														borderRadius: '5px',
														cursor: 'pointer',
													}}>
													‚ùå Odrzuƒá
												</button>
											</div>
										</div>
									))}
								</div>
							)}

						{/* Cz≈Çonkowie */}
						<div>
							<h3>üë• Cz≈Çonkowie ({groupMembers.length})</h3>
							{groupMembers.map(member => (
								<div
									key={member.member_id}
									style={{
										backgroundColor: '#fff',
										padding: '15px',
										borderRadius: '8px',
										marginTop: '10px',
										display: 'flex',
										justifyContent: 'space-between',
										alignItems: 'center',
										border: '1px solid #ddd',
									}}>
									<div>
										<strong>{member.user?.username}</strong>
										<div style={{ fontSize: '12px', color: '#666', marginTop: '5px' }}>
											{member.role === 'creator' ? 'üëë Tw√≥rca' : 'üë§ Cz≈Çonek'}
										</div>
									</div>
									{member.role !== 'creator' &&
										groups.find(g => g.group_id === selectedGroup.group_id)?.role === 'creator' && (
											<button
												onClick={() => handleRemoveMember(selectedGroup.group_id, member.user_id)}
												style={{
													padding: '8px 15px',
													backgroundColor: '#dc3545',
													color: 'white',
													border: 'none',
													borderRadius: '5px',
													cursor: 'pointer',
												}}>
												Usu≈Ñ
											</button>
										)}
								</div>
							))}
						</div>
					</>
				) : (
					<div
						style={{
							display: 'flex',
							justifyContent: 'center',
							alignItems: 'center',
							height: '100%',
							color: '#999',
						}}>
						<p>Wybierz grupƒô aby zobaczyƒá szczeg√≥≈Çy</p>
					</div>
				)}
			</div>
		</div>
	)
}

export default GroupsPage
